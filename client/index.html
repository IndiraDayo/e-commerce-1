<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="app">
        <div id="sideBar">

            <div class="page-wrapper chiller-theme toggled">
                
                <!-- start carousel -->
                <main id="homePage" class="page-content">
                    <div class="container-fluid">
                        <div class="row">

                            <div id="carouselExampleSlidesOnly" class="carousel slide" data-ride="carousel">
                                <div style="top: 100px; left:150px; position:relative; z-index: 1000; font-size: 50px; color: white;">
                                    <p>CibusTree.go</p>
                                </div>
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img class="d-block w-100 item-cover-thumbnail" src="http://3.bp.blogspot.com/-mHBDyO_RdFY/UXiCcStlQlI/AAAAAAAAs38/pUKivG57f3Q/s1600/Food+HD+Wallpapers+(1).jpg" alt="First slide">
                                    </div>
                                    <div class="carousel-item">
                                        <img class="d-block w-100 item-cover-thumbnail" src="http://backgroundcheckall.com/wp-content/uploads/2017/12/background-food-hd-5.jpg" alt="Second slide">
                                    </div>
                                    <div class="carousel-item">
                                        <img class="d-block w-100 item-cover-thumbnail" src="https://c8.alamy.com/comp/FX9RA2/italian-food-background-with-spaghetti-bolognese-ingredients-FX9RA2.jpg" alt="Third slide">
                                    </div>
                                </div>
                            </div>
                            

                        </div>
                    </div>
                </main>
                <!-- end carousel -->

                <!-- navbar -->
                <nav id="navbar" class="choba">
                    <ul style="margin-right: 10%">
                        
                        <!-- <li style="margin-left: 9%; font-size: 30px; bottom: 20px;">CibusTree</li>   -->

                        <li style="margin-left:10%;">
                            <div class="dropdown mr-1" >
                                <button type="button" class="btn btn-primary dropdown-toggle" id="dropdownMenuOffset" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-offset="10,20">
                                  User
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuOffset">
                                  <a class="dropdown-item" href="">Shop</a>
                                  <a class="dropdown-item" href="">Transaction History</a>
                                  <a class="dropdown-item" href="#">Profile</a>
                                </div>
                            </div>
                        </li>

                        <li  style="float:right; margin-left: 30px;" ><button class="btn btn-info" data-toggle="modal" data-target="#cartModal"><span class="fa fa-shopping-cart"></span></button></li>
                        <li v-if="!is_logged_in" v-on:click="loginPressed('login')" style="float:right; margin-left: 30px;" ><button class="btn btn-info" data-toggle="modal" data-target="#loginModal"><span class="fa fa-shopping-cart"></span></button></li>
                        <li v-if="is_logged_in" v-on:click="loggingOut()" style="float:right; margin-left: 10px;" ><button class="btn btn-danger" >logout</button></li>
                        <li v-if="!is_logged_in" v-on:click="loginPressed('register')" style="float:right; margin-left: 10px;" ><button class="btn btn-primary" data-toggle="modal" data-target="#loginModal">Register</button></li>
                        <li v-if="!is_logged_in" v-on:click="loginPressed('login')" style="float:right; margin-left: 10px;" ><button class="btn btn-primary" data-toggle="modal" data-target="#loginModal">Login</button></li>
                        <li style="margin-left: 10px; margin-right: 40px;  margin-top: 13px; padding-left: 10px;"><input v-model="input_search" type="text" class="form-control" placeholder="search..."></li>
                    </ul>
                </nav>
                <!-- end navbar -->


                <div id="homePage" class="container-fluid">
                    <!-- item list on main page -->
                    <div class="row rowy justify-content-around">

                        <div v-for="item in all_item_list" class="card cardy" style="width: 18rem;">
                            <img class="card-img-top item-cover-thumbnail" v-bind:src="item.image" alt="Card image cap">
                            <div class="card-body">
                                
                                    <h5 class="card-title">{{item.name}}</h5>
                                    
                               <!-- <hr> -->
                                <!-- <p class="card-text">{{item.description}}</p> -->
                                <h4 class="card-text" pattern="(d{3})([.])(d{2})">Rp {{item.price}}</h4>
                                <!-- <br> -->
                                <hr>
                                <a v-on:click="itemDetailToModal(item)"  class="btn btn-success" data-toggle="modal" data-target="#itemModal" style="color:white;">Detail</a>
                                <a v-on:click="addingToCart(item)"  class="btn btn-success"><span class="fa fa-cart-plus"></span></a>
                                <a  class="btn btn-info"><span class="fa fa-check"></span></a>
                            </div>
                        </div>

                    </div>
                    <!-- end item list on main page -->
                </div>



                <!-- login modal -->
                <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 v-if="login_pressed" class="modal-title" id="loginModalLabel">Login</h5>
                                <h5 v-if="!login_pressed" class="modal-title" id="loginModalLabel">Register</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <label v-if="!login_pressed">First Name:</label>
                                <input v-if="!login_pressed" v-model="user.first_name" class="form-control" type="text" placeholder="first name">
                                <label v-if="!login_pressed">Last Name:</label>
                                <input v-if="!login_pressed" v-model="user.last_name" class="form-control" type="text" placeholder="last name">
                                <label>Email:</label>
                                <input v-model="user.email" class="form-control" type="email" placeholder="email">
                                <label>Password:</label>
                                <input v-model="user.password" class="form-control" type="password" placeholder="password">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button v-if="login_pressed" v-on:click="loggingIn()" type="button" class="btn btn-primary" data-dismiss="modal">Login</button>
                                <button v-if="!login_pressed" v-on:click="registering()" type="button" class="btn btn-primary">Register</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end login modal -->

                <!-- item modal -->
                <div class="modal fade" id="itemModal" tabindex="-1" role="dialog" aria-labelledby="itemModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-body item-card-margin">
                                <img class="card-img-top item-cover-thumbnail item-cover-detail" v-bind:src="item.image" alt="Card image cap">
                                <hr>
                                <div class="row item-card-margin justify-content-between">
                                    <div>
                                        <h2 >{{item.name}}</h2>
                                        <p  style="color:black;"><span style="color:black;" class="fa fa-store"></span>  {{item.shop_id.name}}</p>
                                    </div>
                                    <h2 class="card-title">Rp {{item.price}}</h2>
                                </div>
                                
                                <div>
                                    <button v-for="category in item.category_list" class="btn btn-primary category-button"><span class="fa fa-tag"></span> {{category.name}}</button>
                                </div>                              
                                <br>
                                <p class="card-text">{{item.description}}</p>
                                <br>
                                <p>stock: {{item.stock}}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <a v-on:click="addingToCart(item)"  class="btn btn-success"><span class="fa fa-cart-plus"></span></a>
                                <a  class="btn btn-info"><span class="fa fa-check"></span></a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end item modal -->

                <!-- cart modal -->
                <div class="modal fade" id="cartModal" tabindex="-1" role="dialog" aria-labelledby="cartModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-body item-card-margin">
                                    <div class="row item-card-margin justify-content-between">
                                        
                                        <h2 ><span class="fa fa-cart-plus" style="color: rgb(61, 99, 61);"></span> item list</h2>
                                        
                                    </div>
                                    <hr>
                                    <div v-if="cart_item_list.length == 0">
                                        <h3 style="color:rgb(150, 165, 148); text-align: center; margin: 90px;">You haven't added any item</h3>
                                    </div>
                                    <div v-for="item_single in cart_item_list">
                                        <div class="card">
                                            <div class="card-body row justify-content-between">
                                                
                                                <p style="font-size: 20px; padding-left: 20px;" class="align-self-start">{{item_single._id.name}}</p>
                                                <div class="align-self-end">
                                                    <span style="font-size:20px; color: black">&nbsp;Rp {{item_single._id.price}}&nbsp;</span>
                                                    <button v-on:click="minusToCart(item_single)" class="btn btn-info"><span class="fa fa-minus"></span></button>
                                                    <span style="font-size:20px; color: black;">&nbsp;{{item_single.quantity}}&nbsp;</span>
                                                    <button v-on:click="plusToCart(item_single)" class="btn btn-info"><span class="fa fa-plus "></span></button>
                                                    <button v-on:click="removingFromCart(item_single)" class="btn btn-danger" style="border-radius: 50%;"><span class="fa fa-times "></span></button>
                                                     
                                                </div>
                                            
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    <h3 style="float:right;">total: Rp {{cart_total}}</h3>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button v-on:click="removeCartDBCompletely()" type="button" class="btn btn-danger" >Remove Cart <span class="fa fa-trash"></span></button>
                                    <a  class="btn btn-success">Pay <span class="fa fa-money-bill"></span></a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end cart modal -->

            </div>
            <!-- page-wrapper -->

        </div>
    </div>
    
    <script>

        // $('.carousel').carousel({
        //     interval: 2000
        // })
            

        Vue.component('my-modal', {
            data: function () {
                return {
                count: 0
                }
            },
            template: `
            
            <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 v-if="login_pressed" class="modal-title" id="loginModalLabel">Login</h5>
                            <h5 v-if="!login_pressed" class="modal-title" id="loginModalLabel">Register</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <input class="form-control" type="text" placeholder="first_name">
                            <input class="form-control" type="text" placeholder="last_name">
                            <input class="form-control" type="text" placeholder="email">
                            <input class="form-control" type="text" placeholder="password">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button v-if="login_pressed" type="button" class="btn btn-primary">Login</button>
                            <button v-if="!login_pressed" type="button" class="btn btn-primary">Register</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            
                `
        })

        // Vue.component()

        new Vue({
            el: '#app',
            data: {
                user: {
                    first_name: '',
                    last_name: '',
                    email: '',
                    password: ''
                },
                item: {
                    name: '',
                    image: '',
                    description: '',
                    category_list: '',
                    price: 0,
                    shop_id: '',
                    user_id: '',
                    stock: 0
                },
                cart_item_list: [],
                to_cart_list: [],
                cart_total:0,
                is_logged_in: false,
                login_pressed: false,
                login_error: false,
                all_item_list: [],
                input_search: '',
            },
            created() {
                if (localStorage.getItem('token')) {
                    this.is_logged_in = true
                }
                this.showAllitems()
                this.getFromCartDB()
                
            },
            watch: {
                input_search: function(val) {
                    if(val === '') {
                        this.showAllitems()
                    }
                    else {
                        this.searchItem(val)
                    }
                },
                is_logged_in: function(val) {
                    this.getFromCartDB()
                },
            },
            methods: {
                loginPressed(val) {
                    if (val == 'login') {
                        this.login_pressed = true
                    }
                    else {
                        this.login_pressed = false
                    } 
                },
                registering() {

                    let self = this

                    axios({
                        method: 'POST',
                        url: `http://localhost:3000/register`,
                        data: {
                            first_name: self.user.first_name,
                            last_name: self.user.last_name,
                            email: self.user.email,
                            password: self.user.password
                        }
                    })
                        .then(response => {
                            this.user.first_name = '',
                            this.user.last_name = ''
                            this.user.email = '',
                            this.user.password = ''
                            
                        })
                        .catch(err => {
                            console.log('error di register', err);
                        })

                    
                    
                },
                loggingIn() {
                    let self = this

                    axios({
                        method: 'POST',
                        url: `http://localhost:3000/login`,
                        data: {
                            email: self.user.email,
                            password: self.user.password
                        }
                    })
                        .then(response => {
                            localStorage.setItem('token', response.data.token)
                            this.is_logged_in = true
                            this.user.email = '',
                            this.user.password = ''
                            
                        })
                        .catch(err => {
                            console.log('error di login', err);
                        })

                    
                    
                },
                loggingOut() {
                    this.is_logged_in = false
                    localStorage.removeItem('token')
                },
                showAllitems() {

                    axios({
                        method: 'GET',
                        url: 'http://localhost:3000/shops/items'
                    })
                        .then(response => {
                            this.all_item_list = response.data.data
                        })
                        .catch(err => {
                            console.log('error di get all item', err);
                            
                        })
                },
                searchItem(val) {
                    axios({
                        method: 'GET',
                        url: `http://localhost:3000/shops/items/search?search=${val}`
                    })
                        .then(response => {
                            this.all_item_list = response.data.data
                        })
                        .catch(err => {
                            console.log('error di get all search item', err);
                            
                        })
                    
                    

                },
                itemDetailToModal(item) {
                    this.item = item
                    this.item_category_list_exclusive = item.category_list  
                },
                addingToCart(item) {
                    let added = false
                    for (let i = 0; i < this.cart_item_list.length; i++) {
                        if (item._id === this.cart_item_list[i]._id._id) {
                            console.log('item sudah ke add');  
                            added = true                         
                        }
                        
                    }
                    console.log('masukkkk');
                    if (added === false) {
                        console.log('coba');
                        
                        this.cart_item_list.push({_id:item, quantity: 1})
                        this.cart_total += item.price
                        console.log(this.cart_item_list, 'yeyey');
                        
                        this.removeCartDB()
                        this.createCartDB()
                       
                    }
                    
                },
                removingFromCart(data) {
                    for(let i = 0; i < this.cart_item_list.length; i++) {
                        if(data._id._id === this.cart_item_list[i]._id._id) {
                            this.cart_item_list.splice(i, 1)
                            this.cart_total -= (data._id.price * data.quantity)
                            i--

                            this.removeCartDB()
                            this.createCartDB()
                            console.log(data._id)
                        }
                    }
                },
                plusToCart(data) {
                    if(data._id.stock > data.quantity) {
                        data.quantity += 1
                        this.cart_total += data._id.price

                        this.removeCartDB()
                        this.createCartDB()
                    }
                },
                minusToCart(data) {
                    if(0 < data.quantity) {
                        data.quantity -= 1
                        this.cart_total -= data._id.price
                        this.removeCartDB()
                        this.createCartDB()
                    }
                    if (data.quantity === 0) {
                        this.removingFromCart(data)
                    }
                },
                createCartDB() {
                    axios({
                            method:'POST',
                            url: 'http://localhost:3000/cart',
                            data: {
                                item_list: this.cart_item_list,
                                total: this.cart_total
                            },
                            headers: {
                                token: localStorage.getItem('token')
                            }
                        })
                            .then(response => {
                                console.log('sukses add yeyeeyye');
                            })
                            .catch(err => {
                                console.log('error add cart', err);
                                
                            })
                },
                getFromCartDB() {
                    axios({
                        method:'GET',
                        url: 'http://localhost:3000/cart',
                        headers: {
                            token: localStorage.getItem('token')
                        }
                    })
                        .then(response => {

                            // for (let i = 0; i < response.data.da)
                            this.cart_item_list = response.data.data.item_list
                            this.to_cart_list = response.data.data.item_list
                            this.cart_total = response.data.data.total
                            console.log('sukses add', this.cart_item_list, 'heyyy', response.data);
                        })
                        .catch(err => {
                            console.log('error add cart', err);
                            
                        })
                },
                removeCartDB() {
                    axios({
                        method:'DELETE',
                        url: 'http://localhost:3000/cart',
                        headers: {
                            token: localStorage.getItem('token')
                        }
                    })
                        .then(response => {
                            console.log('sukses delet cart');
                        })
                        .catch(err => {
                            console.log('error remove cart', err);
                            
                        })
                },
                removeCartDBCompletely() {
                    this.removeCartDB()
                    this.cart_item_list = []
                }
            }
        });
    
    </script>
</body>
</html>